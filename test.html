<!DOCTYPE html>
<html>
<head>
  <title>WMTS</title>
  <link rel="stylesheet" href="https://openlayers.org/en/v4.2.0/css/ol.css" type="text/css">
  <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
  <script src="https://openlayers.org/en/v4.2.0/build/ol.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.3/proj4.js"></script>
</head>
<body>
<div id="map" class="map"></div>
<script>
  proj4.defs("EPSG:3395", "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs");
  ol.proj.get('EPSG:3395').setExtent(
    [1142368, 7447444.4, 4868884.5, 11173960.9]
  );
  /*ol.proj.get('EPSG:3395').setWorldExtent(
    [-180, -90, 180, 90]
  );*/

  var useWGS84 = window.location.hash.indexOf('wgs84') !== -1
  console.log('using wgs84', useWGS84)
  var projection, tileMatrixSet, center
  if (useWGS84) {
    projection = ol.proj.get('EPSG:4326'); // same as wgs84
    tileMatrixSet = 'WGS84_Pseudo-Mercator'
    center = [64, 24]
  } else {
    tileMatrixSet = 'EPSG:3395_FTA'
    projection = ol.proj.get('EPSG:3395');
    var e = projection.getExtent()
    center = [e[0] + (e[2] - e[0]) / 2, e[1] + (e[3] - e[1]) / 3]
  }

  var projectionExtent = projection.getExtent();
  var tileSize = 256
  var size = ol.extent.getWidth(projectionExtent) / tileSize;
  var resolutions = new Array(18);
  var matrixIds = new Array(18);
  for (var z = 0; z < 18; ++z) {
    // generate resolutions and matrixIds arrays for this WMTS
    resolutions[z] = size / Math.pow(2, z);
    matrixIds[z] = tileMatrixSet +':'+z;
    //matrixIds[z] = 'WGS84_Pseudo-Mercator:'+z;
  }

  var map = new ol.Map({
    layers: [
      new ol.layer.Tile({
        source: new ol.source.OSM(),
        opacity: 0.7
      }),
      getLayer('liikennevirasto:Rannikkokartat public', resolutions[2]),
      //getLayer('liikennevirasto:Merikarttasarjojen erikoiskartat public', resolutions[10])
    ],
    target: 'map',
    controls: ol.control.defaults({
      attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
        collapsible: false
      })
    }),
    view: new ol.View({
      center: center,
      zoom: 6
    })
  });

  function getLayer(layer, maxResolution) {
    var source = new ol.source.WMTS({
      url: 'https://julkinen.liikennevirasto.fi/rasteripalvelu/service/wmts',
      layer: layer,
      matrixSet: tileMatrixSet,
      format: 'image/png',
      projection: projection,
      tileGrid: new ol.tilegrid.WMTS({
        extent: projectionExtent,
        resolutions: resolutions,
        matrixIds: matrixIds,
        tileSize: tileSize
      }),
      style: 'default',
      wrapX: true
    })
    //source.setRenderReprojectionEdges(true)
    return new ol.layer.Tile({
      opacity: 0.5,
      //maxResolution: maxResolution,
      source: source
    })
  }
</script>
</body>
</html>